<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Milk Button — Sender Config</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --border: #2a2a2a;
      --text: #e8e8e8;
      --text-muted: #888;
      --accent: #7c9c6b;
      --accent-hover: #8faf7a;
      --danger: #c75c5c;
      --danger-hover: #d97070;
      --radius: 10px;
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "DM Sans", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 24px;
    }
    .container { max-width: 560px; margin: 0 auto; }
    h1 { font-size: 1.5rem; font-weight: 600; margin: 0 0 24px; letter-spacing: -0.02em; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .card h2 {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin: 0 0 16px;
    }
    label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      font: inherit;
      font-size: 1rem;
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 16px;
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(124, 156, 107, 0.25);
    }
    .btn {
      display: inline-block;
      padding: 12px 20px;
      font: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid var(--danger);
      padding: 8px 14px;
      font-size: 0.85rem;
    }
    .btn-danger:hover { background: var(--danger); color: #fff; }
    .btn-outline {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-outline:hover { color: var(--text); border-color: var(--text-muted); }
    .btn-sm { padding: 6px 10px; font-size: 0.85rem; }
    .error { font-size: 0.9rem; color: var(--danger); margin-top: 8px; }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .header-row h1 { margin: 0; }
    .hidden { display: none !important; }

    /* Player URL row: read-only input + Change button */
    .server-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .server-row input[readonly] {
      flex: 1;
      margin-bottom: 0;
      background: var(--surface);
      color: var(--text-muted);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 24px;
    }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--shadow);
    }
    .modal h3 { margin: 0 0 16px; font-size: 1.1rem; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .modal .error { margin-top: 10px; }

    /* Two-column layout for available vs selected */
    .files-section { margin-bottom: 20px; }
    .files-section:last-child { margin-bottom: 0; }
    .file-list {
      list-style: none;
      padding: 0;
      margin: 0 0 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      max-height: 200px;
      overflow-y: auto;
    }
    .file-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
    }
    .file-list li:last-child { border-bottom: none; }
    .file-list li .actions { display: flex; gap: 6px; }
    .file-list.empty { padding: 16px; color: var(--text-muted); font-size: 0.9rem; }
    .file-list .drag-handle { cursor: grab; color: var(--text-muted); padding: 0 4px; }
    .file-list .drag-handle:active { cursor: grabbing; }
    .status { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }
    .status.ok { color: var(--accent); }
    .status.err { color: var(--danger); }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-view" class="card">
      <h1>Milk Button Sender</h1>
      <p style="color: var(--text-muted); margin: 0 0 20px;">Sign in with your system account.</p>
      <form id="login-form">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" autocomplete="username" required>
        <label for="password">Password</label>
        <input type="password" id="password" name="password" autocomplete="current-password" required>
        <div id="login-error" class="error hidden"></div>
        <button type="submit" class="btn btn-primary">Sign in</button>
      </form>
    </div>

    <div id="dashboard-view" class="hidden">
      <div class="header-row">
        <h1>Milk Button Sender</h1>
        <button type="button" class="btn btn-outline" id="logout-btn">Sign out</button>
      </div>

      <div class="card">
        <h2>Player URL</h2>
        <div class="server-row">
          <input type="text" id="server-display" readonly placeholder="Not set" value="">
          <button type="button" class="btn btn-outline" id="server-change-btn">Change</button>
        </div>
      </div>

      <div class="card">
        <h2>Audio files to send</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0 0 16px;">When the button is pressed, these files are sent to the player in order. Add, remove, or reorder below.</p>
        <div class="files-section">
          <label>Available on player</label>
          <ul class="file-list" id="available-list"></ul>
        </div>
        <div class="files-section">
          <label>Selected for send (order matters)</label>
          <ul class="file-list" id="selected-list"></ul>
          <span class="status" id="selected-status"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Change player URL -->
  <div id="server-modal" class="modal-backdrop hidden">
    <div class="modal">
      <h3>Change player URL</h3>
      <label for="server-input">URL (e.g. http://192.168.1.2:8000)</label>
      <input type="text" id="server-input" placeholder="http://...">
      <div id="server-modal-error" class="error hidden"></div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="server-modal-cancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="server-modal-save">Save</button>
      </div>
    </div>
  </div>

  <script>
    const loginView = document.getElementById("login-view");
    const dashboardView = document.getElementById("dashboard-view");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const logoutBtn = document.getElementById("logout-btn");
    const serverDisplay = document.getElementById("server-display");
    const serverChangeBtn = document.getElementById("server-change-btn");
    const serverModal = document.getElementById("server-modal");
    const serverInput = document.getElementById("server-input");
    const serverModalError = document.getElementById("server-modal-error");
    const serverModalCancel = document.getElementById("server-modal-cancel");
    const serverModalSave = document.getElementById("server-modal-save");
    const availableList = document.getElementById("available-list");
    const selectedList = document.getElementById("selected-list");
    const selectedStatus = document.getElementById("selected-status");

    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }
    function setStatus(el, text, ok) {
      el.textContent = text;
      el.className = "status " + (ok ? "ok" : "err");
      if (text) show(el); else hide(el);
    }

    function api(method, path, body) {
      const opts = { method, credentials: "same-origin" };
      if (body !== undefined) {
        opts.headers = { "Content-Type": "application/json" };
        opts.body = typeof body === "string" ? body : JSON.stringify(body);
      }
      return fetch(path, opts);
    }

    let config = { server: null, available_audio_files: [], audio_files_to_send: [] };

    function showLogin(err) {
      hide(dashboardView);
      show(loginView);
      loginError.textContent = err || "";
      if (err) show(loginError); else hide(loginError);
    }

    function showDashboard() {
      hide(loginView);
      show(dashboardView);
      refreshConfig();
    }

    function refreshConfig() {
      api("GET", "/api/config")
        .then(r => r.json())
        .then(c => {
          config = c;
          serverDisplay.value = config.server || "";
          serverDisplay.placeholder = config.server ? "" : "Not set";
          renderAvailable();
          renderSelected();
        });
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    function renderAvailable() {
      const available = config.available_audio_files || [];
      const selected = config.audio_files_to_send || [];
      const selectedSet = new Set(selected);
      availableList.innerHTML = "";
      if (!config.server) {
        availableList.className = "file-list empty";
        availableList.textContent = "Set player URL first.";
        return;
      }
      availableList.className = "file-list";
      if (available.length === 0) {
        availableList.classList.add("empty");
        availableList.textContent = "No audio files on player.";
        return;
      }
      available.forEach(name => {
        const li = document.createElement("li");
        const canAdd = !selectedSet.has(name);
        li.innerHTML = `<span>${escapeHtml(name)}</span><div class="actions"><button type="button" class="btn btn-primary btn-sm" ${!canAdd ? "disabled" : ""}>Add</button></div>`;
        if (canAdd) {
          li.querySelector("button").addEventListener("click", () => addSelected(name));
        }
        availableList.appendChild(li);
      });
    }

    function renderSelected() {
      const selected = config.audio_files_to_send || [];
      selectedList.innerHTML = "";
      selectedList.className = "file-list";
      if (selected.length === 0) {
        selectedList.classList.add("empty");
        selectedList.textContent = "No files selected. Add from the list above.";
        selectedStatus.textContent = "";
        return;
      }
      selected.forEach((name, index) => {
        const li = document.createElement("li");
        li.dataset.name = name;
        li.innerHTML = `
          <span><span class="drag-handle" title="Drag to reorder">⋮⋮</span> ${escapeHtml(name)}</span>
          <div class="actions">
            <button type="button" class="btn btn-sm btn-outline" data-action="up" ${index === 0 ? "disabled" : ""}>Up</button>
            <button type="button" class="btn btn-sm btn-outline" data-action="down" ${index === selected.length - 1 ? "disabled" : ""}>Down</button>
            <button type="button" class="btn btn-danger btn-sm">Remove</button>
          </div>
        `;
        li.querySelector("[data-action=up]").addEventListener("click", () => moveSelected(index, -1));
        li.querySelector("[data-action=down]").addEventListener("click", () => moveSelected(index, 1));
        li.querySelector(".btn-danger").addEventListener("click", () => removeSelected(name));
        selectedList.appendChild(li);
      });
      selectedStatus.textContent = "";
    }

    function addSelected(name) {
      const next = (config.audio_files_to_send || []).slice();
      if (next.includes(name)) return;
      next.push(name);
      saveSelected(next);
    }

    function removeSelected(name) {
      const next = (config.audio_files_to_send || []).filter(f => f !== name);
      saveSelected(next);
    }

    function moveSelected(index, delta) {
      const next = (config.audio_files_to_send || []).slice();
      const ni = index + delta;
      if (ni < 0 || ni >= next.length) return;
      [next[index], next[ni]] = [next[ni], next[index]];
      saveSelected(next);
    }

    function saveSelected(order) {
      api("PATCH", "/api/config", { audio_files_to_send: order })
        .then(r => {
          if (!r.ok) throw new Error("Save failed");
          return r.json();
        })
        .then(c => {
          config = c;
          renderAvailable();
          renderSelected();
          setStatus(selectedStatus, "Saved", true);
          setTimeout(() => { selectedStatus.textContent = ""; }, 2000);
        })
        .catch(() => setStatus(selectedStatus, "Save failed", false));
    }

    // --- Login ---
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      hide(loginError);
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      api("POST", "/login", { username, password })
        .then(r => r.json().then(data => ({ ok: r.ok, data })))
        .then(({ ok, data }) => {
          if (ok && data.ok) showDashboard();
          else showLogin(data.error || "Login failed");
        })
        .catch(() => showLogin("Login failed"));
    });

    logoutBtn.addEventListener("click", () => {
      api("POST", "/logout").then(() => showLogin());
    });

    // --- Server URL modal ---
    serverChangeBtn.addEventListener("click", () => {
      serverInput.value = config.server || "";
      hide(serverModalError);
      serverModalError.textContent = "";
      serverInput.focus();
      show(serverModal);
    });

    serverModalCancel.addEventListener("click", () => hide(serverModal));

    serverModalSave.addEventListener("click", () => {
      const url = serverInput.value.trim().replace(/\/+$/, "") || null;
      hide(serverModalError);
      if (!url) {
        serverModalError.textContent = "Enter a URL.";
        show(serverModalError);
        return;
      }
      serverModalSave.disabled = true;
      api("PATCH", "/api/config", { server: url })
        .then(r => r.json().then(data => ({ status: r.status, data })))
        .then(({ status, data }) => {
          serverModalSave.disabled = false;
          if (status !== 200) {
            serverModalError.textContent = data.error || "Could not save player URL.";
            show(serverModalError);
            return;
          }
          config = data;
          hide(serverModal);
          serverDisplay.value = config.server || "";
          serverDisplay.placeholder = config.server ? "" : "Not set";
          renderAvailable();
          renderSelected();
        })
        .catch(() => {
          serverModalSave.disabled = false;
          serverModalError.textContent = "Request failed.";
          show(serverModalError);
        });
    });

    // Close modal on backdrop click
    serverModal.addEventListener("click", (e) => {
      if (e.target === serverModal) hide(serverModal);
    });

    // Initial auth check
    api("GET", "/api/config")
      .then(r => {
        if (r.ok) showDashboard();
        else showLogin();
      })
      .catch(() => showLogin());
  </script>
</body>
</html>
